name: "DEV: Deploy"
on: pull_request
jobs:
  heroku-deploy:
    runs-on: ubuntu-latest
    outputs:
      app-url: ${{steps.create-ra.outputs.app-url}}
    steps:
      - uses: actions/checkout@v2
      - uses: rlespinasse/github-slug-action@v3.x
      - uses: thedoctor0/zip-release@master
        with:
          type: tar
          directory: server
          filename: ../server-${{env.GITHUB_HEAD_REF_SLUG}}.tgz
          path: "."
      - uses: ./.github/actions/deploy-heroku-ra
        id: create-ra
        with:
          pipeline-id: 6f0589a9-927b-4d01-add3-642b8fdb479a
          branch-name: ${{env.GITHUB_HEAD_REF_SLUG}}
          source-code-dir: ./server-${{env.GITHUB_HEAD_REF_SLUG}}.tgz
          heroku-api-key: ${{secrets.HEROKU_API_KEY}}
          heroku-app-name: lab-pwa-real-estate-pr-${{github.event.number}}
          pr-number: ${{github.event.number}}
  vercel-deploy:
    runs-on: ubuntu-latest
    needs: [heroku-deploy]
    steps:
      - uses: actions/checkout@v2
      - uses: amondnet/vercel-action@v20
        with:
          vercel-args: --build-env API_URL=${{ needs.heroku-deploy.outputs.app-url }} #Optional
          vercel-token: V8c8P1WTKaIV1YpgZuEjCZLI # Required
          vercel-org-id: HcwgMHjLOtykGfTD6TtM0ChG #Required
          vercel-project-id: prj_ejffl8r3PjAPqXYvxDhLoLDC0NdD #Required
          working-directory: ./client
